{
  "$schema": "https://vega.github.io/schema/vega/v5.json",

  "description": "Stable multi-step Sankey",

  "width": 900,
  "height": 600,

  "signals": [
    { "name": "nodeWidth", "value": 20 },
    { "name": "nodeHeight", "value": 20 },
    { "name": "hgap", "value": 180 },
    { "name": "vgap", "value": 40 }
  ],

  "data": [
    {
      "name": "dataset"
    },

    {
      "name": "links",
      "source": "dataset",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["FROM", "TO"],
          "fields": ["IDCOUNT"],
          "ops": ["sum"],
          "as": ["value"]
        }
      ]
    },

    {
      "name": "nodes",
      "source": "links",
      "transform": [
        { "type": "flatten", "fields": ["FROM", "TO"] },

        {
          "type": "aggregate",
          "groupby": ["flatten"]
        },
        { "type": "formula", "as": "stage", "expr": "toNumber(datum.flatten)" },

        {
          "type": "window",
          "groupby": ["stage"],
          "sort": { "field": "stage" },
          "ops": ["row_number"],
          "as": ["row"]
        },

        {
          "type": "formula",
          "as": "x",
          "expr": "datum.stage==99 ? 4*hgap : (datum.stage-1)*hgap"
        },
        {
          "type": "formula",
          "as": "y",
          "expr": "datum.row * vgap"
        },

        { "type": "identifier", "as": "id" },
