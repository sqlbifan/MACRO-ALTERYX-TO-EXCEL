{
  "data": {
    "name": "dataset"
  },
  "height": "container",
  "width": "container",
  "padding": {
    "left": 20,
    "top": 20,
    "right": 20,
    "bottom": 20
  },

  "transform": [
    {
      "calculate": "isValid(datum.Percent) ? 1 : 0",
      "as": "SelectedFlag"
    }
  ],

  "encoding": {
    "x": {
      "timeUnit": "yearmonth",
      "field": "Date",
      "type": "ordinal",
      "title": "",
      "axis": {
        "labelAngle": 0,
        "labelExpr": "[timeFormat(datum.value, '%b'), timeFormat(datum.value, '%m') ? timeFormat(datum.value, '%Y') : '']"
      }
    },
    "y": {
      "aggregate": "sum",
      "field": "Percent",
      "type": "quantitative",
      "axis": false,
      "stack": "zero"
    },
    "color": {
      "field": "Category",
      "type": "nominal",
      "scale": {
        "domain":["דיגיטל", "אחרים","מרכז משכנתאות","מחשבון משכנתה","רכזים","טפסי ליד","ליבי","מיניסייט","מסעות לקוח","שתפים","לידים"],
        "range": ["#5D5D67","#D8DFE7","#7C5BE4","#000000","#00ACEF","#A9B0BB","#B62AA7","#5D5D67","#FCCD50","#000000","#F87460"]
      }
    },
    "order": {
      "aggregate": "sum",
      "field": "Percent",
      "type": "quantitative"
    }
  },

  "layer": [
    {
      "mark": {
        "type": "area",
        "interpolate": "monotone",
        "tooltip": true
      },
      "encoding": {
        "opacity": {
          "condition": {
            "test": "datum.SelectedFlag == 1",
            "value": 1
          },
          "value": 0.15
        }
      }
    },

    {
      "transform": [
        {
          "window": [
            {
              "op": "rank",
              "as": "rank"
            }
          ],
          "sort": [
            {
              "field": "Date",
              "order": "ascending"
            }
          ]
        },
        {
          "filter": "datum.rank === 1"
        }
      ],
      "layer": [
        {
          "mark": {
            "type": "bar",
            "stroke": "white",
            "width": 15,
            "xOffset": -10,
            "tooltip": true
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "right",
            "baseline": "top",
            "dx": -20
          },
          "encoding": {
            "text": {
              "aggregate": "sum",
              "field": "Percent",
              "format": "1.0%"
            }
          }
        }
      ]
    },

    {
      "transform": [
        {
          "window": [
            {
              "op": "rank",
              "as": "rank"
            }
          ],
          "sort": [
            {
              "field": "Date",
              "order": "descending"
            }
          ]
        },
        {
          "filter": "datum.rank === 1"
        },
        {
          "calculate": "format(datum['Percent'], '1.0%')",
          "as": "percentformatted"
        },
        {
          "calculate": "datum['percentformatted']+', ' +datum['Category']",
          "as": "label"
        }
      ],
      "layer": [
        {
          "mark": {
            "type": "bar",
            "stroke": "white",
            "width": 15,
            "xOffset": 10,
            "tooltip": true
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "left",
            "baseline": "top",
            "dx": 20
          },
          "encoding": {
            "text": {
              "field": "label"
            }
          }
        }
      ]
    },

    {
      "mark": {
        "type": "bar",
        "stroke": "",
        "width": 2,
        "tooltip": true
      },
      "encoding": {
        "color": {
          "value": "white"
        }
      }
    },

    {
      "mark": {
        "type": "text",
        "stroke": "",
        "width": 2,
        "dy": -8,
        "tooltip": true
      },
      "encoding": {
        "text": {
          "aggregate": "sum",
          "field": "Percent",
          "format": "1.0%"
        },
        "color": {
          "value": "transparent"
        }
      }
    }
  ]
}
