{
  "$schema": "https://vega.github.io/schema/vega/v5.json",

  "description": "Simple Sankey without dates",

  "padding": 5,
  "width": 900,
  "height": 500,

  "signals": [
    { "name": "nodeWidth", "value": 20 },
    { "name": "nodePadding", "value": 10 }
  ],

  "data": [
    {
      "name": "dataset"
    },

    {
      "name": "links",
      "source": "dataset",
      "transform": [
        {
          "type": "aggregate",
          "groupby": ["previous_department", "current_department"],
          "ops": ["count"],
          "as": ["count"]
        },
        {
          "type": "formula",
          "as": "source",
          "expr": "datum.previous_department"
        },
        {
          "type": "formula",
          "as": "target",
          "expr": "datum.current_department"
        }
      ]
    },

    {
      "name": "nodes",
      "source": "links",
      "transform": [
        {
          "type": "flatten",
          "fields": ["source", "target"]
        },
        {
          "type": "aggregate",
          "groupby": ["flatten"]
        },
        {
          "type": "formula",
          "as": "name",
          "expr": "datum.flatten"
        },
        {
          "type": "identifier",
          "as": "id"
        }
      ]
    },

    {
      "name": "sankey",
      "source": "links",
      "transform": [
        {
          "type": "lookup",
          "from": "nodes",
          "key": "name",
          "fields": ["source"],
          "as": ["sourceNode"]
        },
        {
          "type": "lookup",
          "from": "nodes",
          "key": "name",
          "fields": ["target"],
          "as": ["targetNode"]
        },
        {
          "type": "linkpath",
          "shape": "sankey",
          "sourceX": { "expr": "datum.sourceNode.id * 150 + nodeWidth" },
          "sourceY": { "expr": "datum.sourceNode.id * nodePadding + 50" },
          "targetX": { "expr": "datum.targetNode.id * 150" },
          "targetY": { "expr": "datum.targetNode.id * nodePadding + 50" }
        }
      ]
    }
  ],

  "marks": [
    {
      "type": "path",
      "from": { "data": "sankey" },
      "encode": {
        "update": {
          "stroke": { "value": "#999" },
          "strokeWidth": { "signal": "max(1, datum.count)" },
          "strokeOpacity": { "value": 0.6 },
          "path": { "field": "path" },
          "tooltip": {
            "signal": "datum.source + ' â†’ ' + datum.target + ': ' + datum.count"
          }
        }
      }
    },

    {
      "type": "rect",
      "from": { "data": "nodes" },
      "encode": {
        "update": {
          "x": { "expr": "datum.id * 150" },
          "y": { "expr": "datum.id * nodePadding + 30" },
          "height": { "value": 20 },
          "width": { "signal": "nodeWidth" },
          "fill": { "value": "#1f77b4" },
          "tooltip": { "signal": "datum.name" }
        }
      }
    },

    {
      "type": "text",
      "from": { "data": "nodes" },
      "encode": {
        "update": {
          "text": { "field": "name" },
          "x": { "expr": "datum.id * 150 + nodeWidth + 5" },
          "y": { "expr": "datum.id * nodePadding + 40" },
          "fontSize": { "value": 12 },
          "align": { "value": "left" }
        }
      }
    }
  ]
}
