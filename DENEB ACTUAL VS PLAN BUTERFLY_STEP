{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "spacing":-5 ,
 // "autosize": {"type": "fit-y", "contains": "padding"},
  "config": {
    "title": {
      "font": "Segoe UI",
      "fontSize": 16,
      "fontWeight": "bold"
    }
  },
  "params": [{
    "name": "barheight",
    "value": 30
    //"bind": {"input": "range", "min": 1, "max": 100, "step": 1} // adds a slider
  },
  {
    "name": "TextSize",
    "value": 15
  },
  {
    "name": "TextSize2",
    "value": 13
  },
  {
  "name": "minTextPctLeft",
  "value": 0.18
},
{
  "name": "minTextPctRight",
  "value": 0.18
},
{
  "name": "sort_field",
  "expr": "data('dataset')[0].Sort_By"
}
  ],
  "data": {"name": "dataset"},
  "hconcat": [
    /* --------- LEFT (mirror, responsive, no Y axis) --------- */
    {
      "title": {"text": "מרווח", "anchor": "middle",
      "color": "#B3B3B3",
      "font": "Segoe UI",
      "fontWeight": "bold",
      "subtitle":null
      
      },
      "transform": [
        {"calculate": "-datum.ACTUAL_2", "as": "NEG_ACTUAL_2"},
        {"calculate": "-datum.plan_2", "as": "NEG_plan_2"},
        {"calculate": "datum.ACTUAL_vs_TARGET_2", "as": "AVT2"},
        {
          "joinaggregate": [
            {"op": "max", "field": "ACTUAL_2", "as": "MaxActual2"},
            {"op": "max", "field": "plan_2", "as": "MaxPlan2"}
          ]
        },
        { "calculate": "datum.MaxActual2 > datum.MaxPlan2 ? -datum.MaxActual2 : -datum.MaxPlan2", "as": "GRID_XMIN_L" },
        { "calculate": "datum.MaxActual2 > datum.MaxPlan2 ? datum.MaxActual2 : datum.MaxPlan2", "as": "GRID_XMAX_L" },
        { "calculate": "datum.ACTUAL_2 / datum.GRID_XMAX_L", "as": "BAR_PCT_LEFT" }
      ],
      "width": "container",
      //"width": 100, 
      "height": {"step": 40}, 
      "layer": [
        {
          "name": "y_labels_clickable",
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "normal",
            "size": 15,
            "align": "right",
            "baseline": "middle",
            "dx": 6,
            "cursor": "pointer"
          },
          "encoding": {
            "y": { "field": "ZONE_DESC", "type": "nominal", "bandPosition": 0.5 },
            "x": { "value": -40, "type": "quantitative" },  // מציב את הטקסט ליד שפת הגרף
            "text": { "field": "ZONE_DESC" },
            "tooltip": [{ "field": "ZONE_DESC", "type": "nominal", "title": "קטגוריה" }]
          }
        },
        {
          // grid line y axis
          "name": "gridlines_left", 
          "mark": { "type": "rule", "color": "#E6E6E6", "size": 2, "opacity": 1, "zindex": 0, "yOffset": 20 },
          "encoding": {
            "y": { "field": "ZONE_DESC", "type": "nominal", "bandPosition": 0.5 },
            "x": { "value":-100},
            "x2": { "value": 0 }
          }
        },
                  
        {
          // plan_2 bar
          "mark": {"type": "bar", 
          "color": {"expr": "datum['AVT2']<0? '#F87460': '#F4F2F2'"},
          "height":{"expr": "barheight"},
          "stroke": null
          },
          "encoding": {
            "x": {"field": "NEG_plan_2", "type": "quantitative", "axis": null},
            "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          }
        },
        
        {
          // actual_2_bar
          "mark": {"type": "bar",
            "color": {"expr": "datum['AVT2']>1? '#15B29E': '#094780'"},
           "height":{"expr": "barheight"} 
           },
          "encoding": {
            "x": {"field": "NEG_ACTUAL_2", "type": "quantitative", "axis": null},
            "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          }
        },
        {
          // TARGET MARK
          "mark": {
            "type": "rule",
            "color": "#cccccc",            
            "point": {
              "shape": "M0 0h1v15h-1z",
              "yOffset": -16,
              "size": 17,
              "color": {"expr": "datum['AVT2']>1? '#FFFFFF00': '#808080'"}
              //"opacity": {"expr": "datum['AVT2']>1? 0.5: 1"}
            },
            "stroke": "#FFFFFF00"
          },
          "encoding": {
            "x": {"field": "NEG_plan_2", "type": "quantitative", "axis": null}
          }
        },
      
        {
          //actual_2 text
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            //"align": {"expr": "datum['AVT2'] < 0.65 ? 'right' : 'left'"},
            "align": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? 'left' : 'right'"},
            //"xOffset": {"expr": "abs(datum['AVT2']) < 0.65 ?-3 : 3"},
            "xOffset": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? 3 : -3"},
            //"color": {"expr": "datum['AVT2']>0.65? datum['AVT2']>1? '#FFFFFF': '#70BBFF': '#FFFFFF00'"},
            "color": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? (datum['ACTUAL_vs_TARGET_2']>1? '#FFFFFF' : '#70BBFF') : '#FFFFFF00'"},
            "yOffset": -6,
            "size": {"expr": "TextSize"} 
          },
          "encoding": {
            "text": {"field": "ACTUAL_2", "format": "#0.0'", "formatType": "pbiFormat"},
            "x": {"field": "NEG_ACTUAL_2", "type": "quantitative", "axis": null}
          }
        },
        {
          //plan_2 text
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            "color": {"expr": "datum['AVT2']>1? '#FFFFFF00': '#808080'"},
            "align": "right",
            "yOffset": {"expr": "datum['AVT2']<1 ? 0 : -16"},
            "xOffset": -3,
            "size": {"expr": "TextSize2"} 
          },
          "encoding": {
            "text": {"field": "plan_2", "format": "#0.0'", "formatType": "pbiFormat"},
            "x": {"field": "NEG_plan_2", "type": "quantitative", "axis": null}
          }
        },
        {
          // actual_vs_target_2 text
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            //"align": {"expr": "datum['AVT2'] < 0.65 ? 'right' : 'left'"},
            "align": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? 'left' : 'right'"},
            //"xOffset": {"expr": "abs(datum['AVT2']) < 0.65 ?-3 : 3"},
            "xOffset": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? 3 : -3"},
            //"color": {"expr": "datum['AVT2']>0.65? datum['AVT2']>1? '#FFFFFF': '#70BBFF': '#FFFFFF00'"},
            "color": {"expr": "datum.BAR_PCT_LEFT >= minTextPctLeft ? (datum['ACTUAL_vs_TARGET_2']>1? '#FFFFFF' : '#70BBFF') : '#FFFFFF00'"},
            "yOffset": 7,
            "size": {"expr": "TextSize2"} 
          },
          "encoding": {
            "text": {"field": "AVT2", "format": "##0.0%'", "formatType": "pbiFormat"},
            "x": {"field": "NEG_ACTUAL_2", "type": "quantitative", "axis": null}
          }
        }
      ],
      "encoding": {
        "y": {
          "field": "ZONE_DESC",
          "type": "nominal",
          "title": null,
          "sort": {"field": "SORT_BY 2" , "order": "descending"},
          "axis": {
          "labels": false,
          "labelFont": "Segoe UI",
          "labelFontSize": 15,
          "labelFontWeight": "normal",
          "labelPadding": 30,
          "labelBaseline": "middle" ,
          "labelAlign": "right",
          "grid": true,
          "gridColor": "#E6E6E6",
          "gridWidth": 2,
          "tickBand": "extent",
          "tickSize": 0,
          "tickColor": "#FFFFFF00",
          "domain": false,
          "ticks": true
          }
        }
      }
    },
    /* --------- RIGHT (responsive, keeps Y axis) --------- */
    {
      "title": {"text": "ביצוע", "anchor": "middle",
      "color": "#B3B3B3",
      "font": "Segoe UI",
      "fontWeight": "bold",
      "subtitle":null},
      "transform": [
        {
          "joinaggregate": [
            {"op": "max", "field": "ACTUAL", "as": "MaxActual"},
            {"op": "max", "field": "plan", "as": "Maxplan"}
          ]
        },
        {"calculate": "datum.ACTUAL_vs_TARGET", "as": "AVT"},
        { "calculate": "datum.MaxActual > datum.Maxplan ? datum.MaxActual : datum.Maxplan", "as": "GRID_XMAX_R" },
        { "calculate": "datum.ACTUAL / datum.GRID_XMAX_R", "as": "BAR_PCT_RIGHT" }
      ],
      "width": "container",
      "height": {"step": 40}, 
      "layer": [
       
        {
          // plan bar
          "description": "target bar",
          "mark": {
            "type": "bar",
            "color": "#F4F2F2",
            "height":{"expr": "barheight"},
            "point": {"yOffset": -8, "size": 0.003, "color": "#E6E6E6", "height": 30},
            "stroke": null
          },
          "encoding": {"x": {"field": "plan", "type": "quantitative", "axis": null},
            "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          
          }
        },
        {
          // actual bar
          "description": "actual bar",
          "mark": {"type": "bar", 
          "color": {"expr": "datum['ACTUAL_vs_TARGET']>1? '#15B29E': '#094780'"},
          "height":{"expr": "barheight"}
          
          },
          "encoding": {"x": {"field": "ACTUAL", "type": "quantitative", "axis": null},
          "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          
          }
          

        },
        {
          // plan mark
          "description": "target mark",
          "mark": {
            "type": "rule",
            "color": "#cccccc",
            "point": {
              "shape": "M0 0h1v15h-1z",
              "yOffset": -16,
              "size": 17,
              "color": {"expr": "datum['ACTUAL_vs_TARGET']>1? '#FFFFFF00': '#808080'"},
              //"opacity": {"expr": "datum['ACTUAL_vs_TARGET']>1? 0.5: 1"},
              "height": 30
            },
            "stroke": "#FFFFFF00"
          },
          "encoding": {"x": {"field": "plan", "type": "quantitative", "axis": null},
          "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          }
        },
         {
          //plan mark_2
          "description": "target mark2",
          "mark": {
            "type": "rule",
            "color": "#cccccc",
            "height": 16,
            "point": {
              "shape": "M16 160L160 304L304 160Z",
              "yOffset": -25,
              "xOffset": -8,
              "size": 0.005,
              "color": {"expr": "datum['ACTUAL_vs_TARGET']>1? '#808080': '#FFFFFF00'"},             
              "height": 30
            },
            "stroke": "#FFFFFF00"
          },
          "encoding": {"x": {"field": "plan", "type": "quantitative", "axis": null}}
        },
        {
          // actual text
          "description": "actual label",
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            //"color": {"expr": "datum['ACTUAL']> 10000000? datum['ACTUAL_vs_TARGET']>1? '#FFFFFF': '#70BBFF' : '#FFFFFF00'"},
            "color": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? (datum['ACTUAL_vs_TARGET']>1? '#FFFFFF' : '#70BBFF') : '#FFFFFF00'"},
            //"align": {"expr": "datum['ACTUAL'] < 10000000 ? 'left' : 'right'"},
            "align": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? 'right' : 'left'"},
            //"xOffset": {"expr": "datum['ACTUAL'] < 10000000 ? 3 : -3"},
            "xOffset": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? -3 : 3"},
            "yOffset": -6,
            "size": {"expr": "TextSize"} 
          },
          "encoding": {
            "text": {"field": "ACTUAL", "format": "#,##0,,.0M'", "formatType": "pbiFormat"},
            "x": {"field": "ACTUAL", "type": "quantitative", "axis": null}
          }
        },
        {
          // plan text
          "description": "target label",
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            "color": {"expr": "datum['ACTUAL_vs_TARGET']>1? '#808080': '#808080'"},
            "align": "left",
            "yOffset": {"expr": "datum['ACTUAL_vs_TARGET']<1 ? 0 : -18"},
            "xOffset": 3,
            "size": {"expr": "TextSize2"} 
          },
          "encoding": {
            "text": {"field": "plan", "format": "#,##0,,.0M'", "formatType": "pbiFormat"},
            "x": {"field": "plan", "type": "quantitative", "axis": null},
           "tooltip": [
              {
              "field": "ZONE_DESC",
              "type": "nominal",
              "title": "נציגות"
              },                 
              {
              "field": "plan_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "יעד מרווח"
              },
              {
              "field": "ACTUAL_2",
              "type": "quantitative",
              "format": "#,#0.00'",          
              "formatType": "pbiFormat",
              "title": "מרווח"
              },
              {
              "field": "ACTUAL_vs_TARGET_2",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון מרווח"
              },
              {
              "field": "plan",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "יעד ביצוע"
              },
              {
              "field": "ACTUAL",
              "type": "quantitative",
              "format": "#,##0,,.00M'",          
              "formatType": "pbiFormat",
              "title": "ביצוע"
              },
              {
              "field": "ACTUAL_vs_TARGET",
              "type": "quantitative",
              "format": "#,#0.0%'",          
              "formatType": "pbiFormat",
              "title": "ציון ביצוע"
              }
            ]
          }
        },
        {
          // ACTUAL_vs_TARGET text
          "description": "ACTUAL_vs_TARGET label",
          "mark": {
            "type": "text",
            "font": "Segoe UI",
            "fontWeight": "bold",
            //"color": {"expr": "datum['ACTUAL']> 10000000? datum['ACTUAL_vs_TARGET']>1? '#FFFFFF': '#70BBFF' : '#FFFFFF00'"},
            "color": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? (datum['ACTUAL_vs_TARGET']>1? '#FFFFFF' : '#70BBFF') : '#FFFFFF00'"},
            //"align": {"expr": "datum['ACTUAL'] < 10000000 ? 'left' : 'right'"},
            "align": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? 'right' : 'left'"},
            //"xOffset": {"expr": "datum['ACTUAL'] < 10000000 ? 3 : -3"},
            "xOffset": {"expr": "datum.BAR_PCT_RIGHT >= minTextPctRight ? -3 : 3"},
            "yOffset": 7,
            "size": {"expr": "TextSize2"} 
          },
          "encoding": {
            "text": {"field": "ACTUAL_vs_TARGET", "format": "##0.0%'", "formatType": "pbiFormat"},
            "x": {"field": "ACTUAL", "type": "quantitative", "axis": null}
          }
        }
      ],
      "encoding": {
        "y": {
          "field": "ZONE_DESC",
          "type": "nominal",
          "title": null,
          "sort": {"field": "SORT_BY 2" , "order": "descending"},
          "axis": {
          "grid": true,
          "gridColor": "#EDEDED",
          "gridWidth": 2,
          "labels": false,
          "domain": false,
          "ticks": false,
          "title": null,
          "tickBand": "extent"
        }
          
        }
      }
    }
  ],
 
  "view": {"stroke": null}
}
